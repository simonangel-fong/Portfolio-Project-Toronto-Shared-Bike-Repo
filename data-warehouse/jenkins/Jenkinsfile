pipeline {
  agent any

  environment {
    POSTGRES_USER = credentials('postgres_user')
    POSTGRES_PASSWORD = credentials('postgres_password')
    POSTGRES_DB = credentials('postgres_db')
  }

  stages {

    // stage('Cleanup Workspace & Checkout') {
    //   steps {
    //     echo "#################### Cleans the workspace ####################"
    //     cleanWs()
        
    //     echo "#################### Checkout ####################"
    //     checkout scm // Explicitly checks out the SCM after cleaning.

    //     sh """
    //       ls
    //       pwd
    //       echo "${POSTGRES_USER}"
    //     """
    //   }
    // }

    stage('Start PostgreSQL') {
      steps {
        dir('data-warehouse/postgresql'){
          echo "#################### Spin up PGDB ####################"
          sh '''
            pwd
            ls
            docker compose down -v
            docker compose up

            # Wait until Postgres is ready
            until docker exec -t postgresql bash -lc 'pg_isready -U "${POSTGRES_USER:-postgres}" -d "${POSTGRES_DB:-toronto_shared_bike}"'; do
              echo "Waiting for PostgreSQL to become ready..."
              sleep 10
            done
          '''

          echo "#################### Confirm PGDB ####################"
          sh '''
            docker ps
            docker logs --tail=100 postgresql || true
          '''
        }
      }
    }
  }
}
 